<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>Adobe Target Demo - 0815test (Fixed)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- å»ºè­°ï¼šä»¥ http/https æ–¹å¼é–‹å•Ÿé é¢ï¼Œä¸è¦ç”¨ file:// -->

  <!-- Preconnect / Prefetch for Adobe domains -->
  <link rel="preconnect" href="//dpm.demdex.net">
  <link rel="preconnect" href="//cm.everesttech.net">
  <link rel="preconnect" href="//techmarketingdemos.tt.omtrdc.net">
  <link rel="dns-prefetch" href="//dpm.demdex.net">
  <link rel="dns-prefetch" href="//cm.everesttech.net">
  <link rel="dns-prefetch" href="//techmarketingdemos.tt.omtrdc.net">

  <!-- ï¼ˆé¸ç”¨ï¼‰ç°¡å–® data layerï¼›ä¹Ÿå¯æ”¹ç”± Launch è¨­å®š -->
  <script>
    window.digitalData = {
      page: { pageInfo: { pageName: "home" } }
    };
  </script>

  <!-- Anti-flickerï¼ˆé¿å…åœ¨å¥—ç”¨ Offer å‰é–ƒå±ï¼‰ -->
  <style id="at-body-style">body{opacity:0!important;}</style>
  <script>
    // ä¿éšªæ©Ÿåˆ¶ï¼šæœ€å¤šéš±è— 3 ç§’ï¼Œé¿å…æ•´é é•·æœŸéš±å½¢
    setTimeout(function(){
      var s = document.getElementById("at-body-style");
      if (s && s.parentNode) s.parentNode.removeChild(s);
    }, 3000);
  </script>

  <!-- Adobe Launchï¼ˆéœ€åŒ…å« at.jsï¼›ä»¥ deferï¼Œç¢ºä¿ DOM è§£æå¾Œå†åŸ·è¡Œï¼‰ -->
  <!-- âš ï¸ è«‹æ›¿æ›æˆä½ è‡ªå·±ç’°å¢ƒçš„ Launch ç¨‹å¼ç¢¼ï¼ˆä»¥ä¸‹ç‚ºç¤ºä¾‹ä»£ç¢¼ï¼‰ -->
  <script
    src="https://assets.adobedtm.com/c88561b17244/34dbf331cabd/launch-6e41b0bf85df-development.min.js"
    defer>
  </script>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif; line-height: 1.55; padding: 24px; }
    code { background: #f6f8fa; padding: 2px 6px; border-radius: 4px; }
    .note { background: #fffbe6; border: 1px solid #ffe58f; padding: 12px; border-radius: 8px; margin: 16px 0; }
    .box { border: 1px dashed #bbb; padding: 16px; border-radius: 8px; margin: 16px 0; }
  </style>
</head>

<body>
  <h1>Adobe Target Demoï¼ˆé è¨­æ”¹ #0815testï¼›å¯åˆ‡æ›æˆæ”¹ h1ï¼‰</h1>
  <p>æ­¤é ç¤ºç¯„ <strong>Form-Based</strong> + <code>getOffer</code>/<code>applyOffer(selector)</code> çš„åŸºæœ¬æµç¨‹ã€‚</p>

  <div class="note">
    <strong>ä½¿ç”¨èªªæ˜ï¼š</strong>
    <ol>
      <li>Target æ´»å‹•ä½¿ç”¨ <em>Form-Based</em>ï¼ŒLocation åç¨±è«‹å¡« <code>0815test</code>ï¼ˆå’Œæœ¬é  mbox åç¨±ä¸€è‡´ï¼‰ã€‚</li>
      <li>æ´»å‹•ç‹€æ…‹éœ€ç‚º <em>Approved/Active</em>ï¼Œä¸” URL targeting è¦å‘½ä¸­æ­¤é ç¶²å€ï¼ˆå¦‚ <code>localhost</code>ï¼‰ã€‚</li>
      <li>è‹¥ä½ æƒ³ç›´æ¥æ›¿æ›æœ€ä¸Šæ–¹ <code>&lt;h1&gt;</code>ï¼ŒæŠŠä¸‹æ–¹ç¨‹å¼ç¢¼ä¸­çš„ <code>APPLY_TO_SELECTOR</code> æ”¹ç‚º <code>"h1"</code> å³å¯ã€‚</li>
      <li>å»ºè­°ä»¥ <em>QA URL</em> æˆ–åœ¨ç¶²å€åŠ ä¸Š <code>?mboxDebug=1&amp;mboxTrace=window</code> ä¾†æª¢æŸ¥æ˜¯å¦å‘½ä¸­æ´»å‹•/é«”é©—ã€‚</li>
    </ol>
  </div>

  <div class="box">
    <h3>mbox å®¹å™¨ï¼ˆDefault Contentï¼‰</h3>
    <div id="0815test" class="mboxDefault">
      <p>é€™æ˜¯é è¨­å…§å®¹ï¼ˆDefaultï¼‰ã€‚è‹¥ Target æ´»å‹•å‘½ä¸­ä¸¦å›å‚³ Offerï¼Œå°‡ä»¥ Offer å…§å®¹æ›¿æ›ã€‚</p>
    </div>
  </div>

  <hr/>

  <p>
    <button id="btnForce">æ‰‹å‹•é‡æ–°è«‹æ±‚ Offer</button>
    <span id="status" style="margin-left:8px;color:#666"></span>
  </p>

  <script>
    // === ä½ å¯ä»¥åœ¨é€™è£¡åˆ‡æ›è¦æ›¿æ›çš„å…ƒç´  ===
    // é è¨­æ›¿æ› #0815test å®¹å™¨ï¼›è‹¥æƒ³ç›´æ¥æ”¹ <h1>ï¼ŒæŠŠä¸‹è¡Œæ”¹æˆ: const APPLY_TO_SELECTOR = "h1";
    const APPLY_TO_SELECTOR = "#0815test";

    // ï¼ˆé¸ç”¨ï¼‰è‹¥é é¢è¼‰å…¥æ™‚ AppMeasurement å­˜åœ¨ï¼Œè¨­å®š pageName ä»¥é¿å…å ±è¡¨å‡ºç¾ undefined
    (function setPageNameIfAppMeasurementExists() {
      try {
        if (window.s && !window.s.pageName) {
          window.s.pageName = (document.title || "0815test") + "";
          console.log("â„¹ï¸ AppMeasurement pageName set to:", window.s.pageName);
        } else {
          console.log("â„¹ï¸ The page name is:",
            (window.s && window.s.pageName) ||
            (window.digitalData && window.digitalData.page && window.digitalData.page.pageInfo && window.digitalData.page.pageInfo.pageName) ||
            "undefined"
          );
        }
      } catch (e) { /* éœé»˜è™•ç† */ }
    })();

    function removeAntiFlicker() {
      var s = document.getElementById("at-body-style");
      if (s && s.parentNode) s.parentNode.removeChild(s);
    }

    // ç™¼é€ä¸¦å¥—ç”¨ 0815test çš„ Offerï¼ˆselector ç‰ˆï¼‰
    function requestOffer0815() {
      console.log("ğŸŒ Requesting offer for mbox=0815test...");
      const $status = document.getElementById("status");
      if ($status) $status.textContent = "è«‹æ±‚ä¸­â€¦";

      try {
        adobe.target.getOffer({
          mbox: "0815test",
          success: function (offers) {
            console.log("ğŸ“¦ Target offer response:", offers);
            if (offers && offers.length > 0) {
              // âœ… ç”¨ selector æ˜ç¢ºæŒ‡å®šè¦æ›¿æ›çš„å®¹å™¨ï¼ˆå¯æ”¹æˆ "h1" æ¸¬è©¦ç›´æ¥æ›´æ”¹æ¨™é¡Œï¼‰
              adobe.target.applyOffer({
                selector: APPLY_TO_SELECTOR,
                offer: offers
              });
              console.log("âœ… Offer applied to", APPLY_TO_SELECTOR);
              if ($status) $status.textContent = "Offer å·²å¥—ç”¨ â†’ " + APPLY_TO_SELECTOR;
            } else {
              console.warn("âš ï¸ Offer is empty. æª¢æŸ¥ activity / audience / URL targeting / location åç¨±æ˜¯å¦æ­£ç¢ºã€‚");
              if ($status) $status.textContent = "æœªæ”¶åˆ° Offerï¼ˆç©ºï¼‰";
            }
          },
          error: function (status, error) {
            console.error("âŒ Target getOffer Error:", status, error);
            if ($status) $status.textContent = "getOffer å¤±æ•—ï¼š" + status;
          }
        });
      } catch (err) {
        console.error("âŒ adobe.target not ready or getOffer failed:", err);
        if ($status) $status.textContent = "SDK å°šæœªå°±ç·’æˆ– getOffer ä¾‹å¤–";
      } finally {
        removeAntiFlicker();
      }
    }

    // ç­‰å¾… at.js è¼‰å…¥å®Œæˆå¾Œå†å‘¼å«ï¼ˆé¿å… DOMContentLoaded æ™‚ SDK å°šæœªå¯ç”¨ï¼‰
    function waitForTargetAndRun(maxWaitMs) {
      var start = Date.now();
      (function poll() {
        var ready = !!(window.adobe && adobe.target && typeof adobe.target.getOffer === "function");
        if (ready) {
          console.log("âœ… adobe.target SDK ready");
          removeAntiFlicker();
          requestOffer0815();
          return;
        }
        if (Date.now() - start > (maxWaitMs || 5000)) {
          console.error("â° Timeout waiting for Adobe Target SDK.");
          removeAntiFlicker();
          var $status = document.getElementById("status");
          if ($status) $status.textContent = "ç­‰å¾… SDK é€¾æ™‚ï¼ˆ5sï¼‰";
          return;
        }
        setTimeout(poll, 100);
      })();
    }

    // DOM Ready å¾Œå•Ÿå‹•è¼ªè©¢ï¼Œç¢ºä¿ at.js å·²å¯ç”¨
    document.addEventListener("DOMContentLoaded", function () {
      waitForTargetAndRun(5000);

      document.getElementById("btnForce").addEventListener("click", function(){
        requestOffer0815();
      });

      // è‹¥ä½ è¦ç”¨ mboxTrace/mboxDebugï¼Œå»ºè­°æ‰‹å‹•åœ¨ç¶²å€åŠ ä¸Šï¼š
      // ?mboxDebug=1&mboxTrace=window
      // ç„¶å¾Œåœ¨ Network æ‰¾ Target delivery è«‹æ±‚ â†’ Response å…§çš„ trace æª¢æŸ¥ã€ŒMatched Activitiesã€
      if (location.search.includes("mboxDebug") || location.search.includes("mboxTrace")) {
        console.log("ğŸ§ª QA/Debug mode hints: æŸ¥çœ‹ Network â†’ æŸ¥æ‰¾ Target deliveryï¼Œå±•é–‹ trace æª¢æŸ¥æ˜¯å¦å‘½ä¸­æ´»å‹•/é«”é©—ã€‚");
      }
    });
  </script>
</body>
</html>
