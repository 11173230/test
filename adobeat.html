<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Adobe Target Demo - 0815test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Preconnect / Prefetch for Adobe domains -->
  <link rel="preconnect" href="//dpm.demdex.net">
  <link rel="preconnect" href="//cm.everesttech.net">
  <link rel="preconnect" href="//techmarketingdemos.tt.omtrdc.net">
  <link rel="dns-prefetch" href="//dpm.demdex.net">
  <link rel="dns-prefetch" href="//cm.everesttech.net">
  <link rel="dns-prefetch" href="//techmarketingdemos.tt.omtrdc.net">

  <!-- ï¼ˆé¸ç”¨ï¼‰ç°¡å–® data layerï¼›ä¹Ÿå¯æ”¹ç”± Launch è¨­å®š -->
  <script>
    window.digitalData = {
      page: { pageInfo: { pageName: "home" } }
    };
  </script>

  <!-- Anti-flickerï¼ˆé¿å…åœ¨å¥—ç”¨ Offer å‰é–ƒå±ï¼‰ -->
  <script>
    (function (g, b, css, ms) {
      (function (head, id, rule) {
        if (!head) return;
        var s = b.createElement("style");
        s.id = id; s.innerHTML = rule;
        head.appendChild(s);
      })(b.getElementsByTagName("head")[0], "at-body-style", css);

      setTimeout(function () {
        var head = b.getElementsByTagName("head")[0];
        if (!head) return;
        var s = b.getElementById("at-body-style");
        if (s) head.removeChild(s);
      }, ms);
    })(window, document, "body{opacity:0!important}", 3000);
  </script>

  <!-- Adobe Launchï¼ˆå…§å« at.jsï¼›ç”¨ deferï¼Œç¢ºä¿ DOM è§£æå¾Œå†åŸ·è¡Œï¼‰ -->
  <script
    src="https://assets.adobedtm.com/c88561b17244/34dbf331cabd/launch-6e41b0bf85df-development.min.js"
    defer>
  </script>
</head>

<body>
  <h1>Adobe Target Demo</h1>
  <p>This page is using <strong>0815test</strong> mbox for A/B testing.</p>

  <!-- è‡ªè¨‚ mbox å®¹å™¨ï¼ˆID è¦èˆ‡ getOffer çš„ mbox åç¨±ä¸€è‡´ï¼‰ -->
  <div id="0815test" class="mboxDefault">
    <p>This is the default content. If a Target activity is delivered, it will be replaced.</p>
  </div>

  <script>
    // ï¼ˆé¸ç”¨ï¼‰è‹¥é é¢è¼‰å…¥æ™‚ AppMeasurement å­˜åœ¨ï¼Œè¨­å®š pageName ä»¥é¿å…å ±è¡¨å‡ºç¾ undefined
    (function setPageNameIfAppMeasurementExists() {
      try {
        if (window.s && !window.s.pageName) {
          window.s.pageName = (document.title || "0815test") + "";
          console.log("â„¹ï¸ AppMeasurement pageName set to:", window.s.pageName);
        } else {
          console.log("â„¹ï¸ The page name is:",
            (window.s && window.s.pageName) || (window.digitalData && window.digitalData.page && window.digitalData.page.pageInfo && window.digitalData.page.pageInfo.pageName) || "undefined"
          );
        }
      } catch (e) { /* éœé»˜è™•ç† */ }
    })();

    // ç™¼é€ä¸¦å¥—ç”¨ 0815test çš„ Offer
    function requestOffer0815() {
      console.log("ğŸŒ Requesting offer for 0815test...");
      try {
        adobe.target.getOffer({
          mbox: "0815test",
          success: function (offers) {
            console.log("ğŸ“¦ Target offer response:", offers);
            if (offers && offers.length > 0) {
              adobe.target.applyOffer({ mbox: "0815test", offer: offers });
              console.log("âœ… Offer applied to 0815test.");
            } else {
              console.warn("âš ï¸ Offer is empty. Check activity/audience/mbox settings.");
            }
          },
          error: function (status, error) {
            console.error("âŒ Target getOffer Error:", status, error);
          }
        });
      } catch (err) {
        console.error("âŒ adobe.target not ready or getOffer failed:", err);
      }
    }

    // ç­‰å¾… at.js è¼‰å…¥å®Œæˆå¾Œå†å‘¼å«ï¼ˆé¿å… DOMContentLoaded æ™‚ SDK å°šæœªå¯ç”¨ï¼‰
    function waitForTargetAndRun(maxWaitMs) {
      var start = Date.now();
      (function poll() {
        var ready = !!(window.adobe && adobe.target && typeof adobe.target.getOffer === "function");
        if (ready) {
          // ç§»é™¤ anti-flickerï¼ˆè‹¥å°šæœªè‡ªå‹•ç§»é™¤ï¼‰
          var s = document.getElementById("at-body-style");
          if (s && s.parentNode) s.parentNode.removeChild(s);
          requestOffer0815();
          return;
        }
        if (Date.now() - start > (maxWaitMs || 5000)) {
          console.error("â° Timeout waiting for Adobe Target SDK.");
          // é€¾æ™‚ä¹Ÿç§»é™¤ anti-flickerï¼Œé¿å…æ•´é é•·æœŸéš±å½¢
          var st = document.getElementById("at-body-style");
          if (st && st.parentNode) st.parentNode.removeChild(st);
          return;
        }
        setTimeout(poll, 100);
      })();
    }

    // DOM Ready å¾Œå•Ÿå‹•è¼ªè©¢ï¼Œç¢ºä¿ at.js å·²å¯ç”¨
    document.addEventListener("DOMContentLoaded", function () {
      waitForTargetAndRun(5000);
    });
  </script>
</body>
</html>
